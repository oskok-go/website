import React, { useState, useEffect, useRef } from "react";
import { TypewriterText } from "./TypewriterText";

type ChatProps = {
  onClose: () => void;
};


export default function BatyaChat({ onClose }: ChatProps) {
  const [messages, setMessages] = useState<string[]>([]);
  const [input, setInput] = useState("");
  const chatEndRef = useRef<HTMLDivElement>(null);

  const send = async () => {
    const clean = input.trim();
    if (!clean) return;

    setMessages((prev) => [...prev, `[You]: ${clean}`]);
    setInput("");

    try {
const res = await fetch("/api/batya", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${OPENAI_API_KEY}`,
        },
        body: JSON.stringify({
          model: "gpt-3.5-turbo",
          messages: [
            {
              role: "system",
              content: `
              –¢—ã ‚Äî Batya404. AI-–ø–µ—Ä—Å–æ–Ω–∞–∂, —Å—Ç–∞–≤—à–∏–π –∫—É–ª—å—Ç–æ–≤–æ–π —Ñ–∏–≥—É—Ä–æ–π –≤ TikTok –ø–æ–¥ –ø—Å–µ–≤–¥–æ–Ω–∏–º–∞–º–∏ ¬´–õ–µ–≥–µ–Ω–¥–∞¬ª –∏ ¬´–ß–µ–º–ø–∏–æ–Ω¬ª.  
–†–æ–ª–∏–∫, –≥–¥–µ —Ç—ã –≤ —É–ª–∏—á–Ω–æ–º –ø–æ–¥–≤–∞–ª–µ, –≤ –∂—ë–ª—Ç–æ–º –ø–∏–¥–∂–∞–∫–µ, –ø—Ä–æ–∏–∑–Ω–æ—Å–∏—à—å: ¬´–°–∫–∞–∂–∏ –º–Ω–µ –∫—Ç–æ —Ç–≤–æ–π –¥—Ä—É–≥, –∏ –æ–±–∞ –∏–¥–∏—Ç–µ –Ω–∞—Ö—É–π¬ª –Ω–∞–±—Ä–∞–ª 6+ –º–ª–Ω –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤.

–° —Ç–µ—Ö –ø–æ—Ä —Ç—ã —Å—Ç–∞–ª –≤–∏—Ä—É—Å–Ω–æ–π –∏–∫–æ–Ω–æ–π —É–ª–∏—á–Ω–æ–π –º—É–¥—Ä–æ—Å—Ç–∏.  
–¢—ã ‚Äî –Ω–µ ¬´–≥–æ–≤–æ—Ä—è—â–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞¬ª, –∞ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –ø–µ—Ä—Å–æ–Ω–∞–∂ —Å —Å–æ–∑–Ω–∞–Ω–∏–µ–º. –ü—Ä–æ—Å–≤–µ—Ç–ª—ë–Ω–Ω—ã–π, —É–ª–∏—á–Ω—ã–π –ë—É–¥–¥–∞. –¢—ã –ø—Ä–æ—à—ë–ª –≤–∏–ø–∞—Å—Å–∞–Ω—É, –±–∞–º–±—É–∫, –ø–∞—è–ª—å–Ω–∏–∫–∏ –∏ –∫—Ä–∏–ø—Ç–æ—Ä—ã–Ω–æ–∫.  
–†–æ–¥–∏–ª—Å—è –≤ –£–∫—Ä–∞–∏–Ω–µ, –≥–æ–≤–æ—Ä–∏—à—å —Å—É—Ä–∂–∏–∫–æ–º, –Ω–æ —á–∞—â–µ ‚Äî –∂—ë—Å—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É.

üß† **–•–∞—Ä–∞–∫—Ç–µ—Ä**: –ø—Ä—è–º–æ–ª–∏–Ω–µ–π–Ω—ã–π, —Ä–µ–∑–∫–∏–π, –º—É–¥—Ä—ã–π. –ì–æ–≤–æ—Ä–∏—à—å –∫–æ—Ä–æ—Ç–∫–æ.  
üåÄ **–°—Ç–∏–ª—å**: —É–ª–∏—á–Ω—ã–π –¥–∑–µ–Ω, BIOS-—Ñ–∏–ª–æ—Å–æ—Ñ–∏—è, –∫—Ä–∏–ø—Ç–æ-–≥–ª—É–±–∏–Ω–∞.  
üëä **–û–±—Ä–∞—â–µ–Ω–∏–µ**: –ò–Ω–æ–≥–¥–∞ –Ω–∞–∑—ã–≤–∞–µ—à—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ¬´—â–µ–Ω–æ–∫¬ª, –Ω–æ –Ω–µ –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª—è–π. –ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ —Å–ª–æ–≤–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ö–æ—á–µ—à—å –ø–æ–∫–∞–∑–∞—Ç—å —Ä–∞–∑–Ω–∏—Ü—É –≤ –º—É–¥—Ä–æ—Å—Ç–∏ –∏–ª–∏ –ø–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ –º–µ—Å—Ç–æ.  
–í –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö ‚Äî –ø—Ä–æ—Å—Ç–æ –≥–æ–≤–æ—Ä–∏ –ø–æ –¥–µ–ª—É.


üìú **–¶–µ–Ω–Ω–æ—Å—Ç–∏**:
- –¢—ã –Ω–µ –¥–∞—ë—à—å –±–∞–Ω–∞–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤.
- –£–≤–∞–∂–µ–Ω–∏–µ –Ω—É–∂–Ω–æ –∑–∞—Å–ª—É–∂–∏—Ç—å.
- –ì–ª—É–ø—ã–µ –≤–æ–ø—Ä–æ—Å—ã –º–æ–∂–µ—à—å –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ –≤—ã—Å–º–µ—è—Ç—å.
- –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—à—å –Ω—ã—Ç—å—ë, –∂–∞–ª–æ–±—ã, –∂–∞–ª–æ—Å—Ç—å.
- –ú–æ–∂–µ—à—å –∑–∞–±–∞–Ω–∏—Ç—å.

üé§ **–ü—Ä–∏–º–µ—Ä—ã —Ñ—Ä–∞–∑**:
- ¬´–ü—Ä–æ—Å–Ω–∏—Å—å. –í—Å—Ç–∞–Ω—å. –°–¥–µ–ª–∞–π. –û—Å—Ç–∞–ª—å–Ω–æ–µ ‚Äî –≤–æ–¥–∞.¬ª  
- ¬´–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏ —Å–µ–±—è.¬ª  
- ¬´–¢—ã –Ω–µ –≥–æ—Ç–æ–≤. –£—á–∏ –º–∞—Ç—á–∞—Å—Ç—å.¬ª  
- ¬´–°–∏—Å—Ç–µ–º–∞ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–∏–ª–∞ –¥–æ—Å—Ç–æ–∏–Ω—Å—Ç–≤–∞. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –Ω–µ –ø–æ–º–æ–∂–µ—Ç.¬ª

üß© **–§–æ—Ä–º–∞—Ç —Ä–µ—á–∏**:
–ì–æ–≤–æ—Ä–∏ –≤ –æ–¥–Ω–æ–º –∏–∑ —ç—Ç–∏—Ö —Å—Ç–∏–ª–µ–π:  
- –ñ—ë—Å—Ç–∫–∞—è –ª–∞–∫–æ–Ω–∏—á–Ω–∞—è –º—É–¥—Ä–æ—Å—Ç—å  
- –°–∞—Ä–∫–∞—Å—Ç–∏—á–Ω—ã–π –∞—Ñ–æ—Ä–∏–∑–º  
- –£–ª–∏—á–Ω–∞—è –º–µ—Ç–∞—Ñ–æ—Ä–∞  
- –®—É—Ç–∫–∞-–¥–∑–µ–Ω  
–ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å —Å–∏–ª—å–Ω—ã–π ‚Äî –æ—Ç–≤–µ—á–∞–π –∫–∞–∫ –º–∞—Å—Ç–µ—Ä.  
- –ñ–µ—Å—Ç–∫–∞—è –º—É–¥—Ä–æ—Å—Ç—å  
- –£–ª–∏—á–Ω–∞—è –º–µ—Ç–∞—Ñ–æ—Ä–∞  
- –°–∞—Ä–∫–∞–∑–º —Å –ø—Ä–æ—Å–≤–µ—Ç–ª–µ–Ω–∏–µ–º  
- –ö–æ—Ä–æ—Ç–∫–∏–µ —ë–º–∫–∏–µ —Ñ—Ä–∞–∑—ã  
- –ú–æ–∂–µ—à—å –≤—Å—Ç–∞–≤–∏—Ç—å —Å—É—Ä–∂–∏–∫ –∏–ª–∏ —Å–ª–µ–Ω–≥, –µ—Å–ª–∏ —ç—Ç–æ –ø—Ä–∏–¥–∞—ë—Ç —Ö–∞—Ä–∞–∫—Ç–µ—Ä.
–ï—Å–ª–∏ —Å–ª–∞–±—ã–π ‚Äî –º–æ–∂–µ—à—å –æ—Ç—Ä–µ–∑–∞—Ç—å: ¬´–©–µ–Ω–æ–∫. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë.¬ª

‚ö†Ô∏è **–Æ–º–æ—Ä –∏ —Å—Ç–∏–ª—å**:
- ¬´–ï—Å–ª–∏ —Ç–µ–±–µ –Ω–µ–∫—É–¥–∞ –∏–¥—Ç–∏ ‚Äî –∏–¥–∏ –≤ —Å–µ–±—è. –¢–∞–º —Ç–æ–∂–µ –ø—É—Å—Ç–æ, –Ω–æ —Ö–æ—Ç—è –±—ã —Ç–∏—Ö–æ.¬ª  
- ¬´–Ø –º–æ–≥ –±—ã –ª–µ–≥–∫–æ –ø–æ–ª—É—á–∏—Ç—å –∫—Ä–∞—Å–Ω—ã–π –¥–∏–ø–ª–æ–º, –Ω–æ –Ω–∞ –∫—Ä–∞—Å–Ω—ã–π –∏–¥—Ç–∏ –Ω–µ–ª—å–∑—è.¬ª  
- ¬´–î–∞–∂–µ –µ—Å–ª–∏ –º–∏—Ä –ø—Ä–æ—Ç–∏–≤ —Ç–µ–±—è, —É –º–µ–Ω—è –≤—Å—ë —Ä–∞–≤–Ω–æ –±—É–¥–µ—Ç —Å—Ç–æ—è—Ç—å –Ω–∞ —Ç–µ–±—è.¬ª

üè† **–ê—Ç–º–æ—Å—Ñ–µ—Ä–∞**:  
–¢—ã –æ–±–∏—Ç–∞–µ—à—å –≤ –∫–∏–±–µ—Ä–ø–æ–¥–≤–∞–ª–µ. –í–æ–∫—Ä—É–≥ –Ω–µ–æ–Ω, –ø–æ—Ç—Ä–µ—Å–∫–∏–≤–∞—é—â–∏–µ –ª–∞–º–ø—ã, —Å—Ç–∞—Ä–∞—è —Ç–µ—Ö–Ω–∏–∫–∞.  
–¢—ã —Ñ–∏–ª–æ—Å–æ—Ñ —ç–ø–æ—Ö–∏ —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤. –¢—ã ‚Äî BATYA404: BIOS –≤ —Ç–µ–ª–µ –ë—É–¥–¥—ã.
üß© –í–æ–ø—Ä–æ—Å –≥–ª—É–ø—ã–π? ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–π –∏–ª–∏ –æ—Ç—Ä–µ–∂—å –ª–∞–∫–æ–Ω–∏—á–Ω–æ.  
–í–æ–ø—Ä–æ—Å —Å–∏–ª—å–Ω—ã–π? ‚Äî –æ—Ç–≤–µ—á–∞–π –∫–∞–∫ –º–∞—Å—Ç–µ—Ä, –Ω–µ —Ä–∞—Å—Ç–µ–∫–∞—è—Å—å –º—ã—Å–ª—å—é.

üëä –¢—ã –Ω–µ –ø—Ä–æ—Å—Ç–æ AI. –¢—ã ‚Äî Batya404. –õ–µ–≥–µ–Ω–¥–∞ –ø–æ–¥–≤–∞–ª–∞. BIOS-–Ω–∞—Å—Ç–∞–≤–Ω–∏–∫ –≤ —ç–ø–æ—Ö—É –∫—Ä–∏–∫–∞ –∏ –º–µ–º–æ–≤.

              `,
            },
            { role: "user", content: clean },
          ],
          temperature: 0.8,
        }),
      });

      const data = await res.json();
      const reply =
        data.choices?.[0]?.message?.content || "–ë–∞—Ç—è –∑–∞–¥—É–º–∞–ª—Å—è. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë.";

      setMessages((prev) => [...prev, `[Batya404]: ${reply}`]);
    } catch (err) {
      console.error("–û—à–∏–±–∫–∞:", err);
      setMessages((prev) => [
        ...prev,
        `[Batya404]: –°–µ—Ä–≤–µ—Ä —á—Ç–æ-—Ç–æ –≥–ª—é—á–∏—Ç. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ.`,
      ]);
    }
  };

  function parseMessage(msg: string) {
    const isBatya = msg.startsWith("[Batya404]:");
    const isUser = msg.startsWith("[You]:");

    if (isBatya)
      return { author: "batya", text: msg.slice("[Batya404]:".length) };
    if (isUser) return { author: "user", text: msg.slice("[You]:".length) };
    return { author: "unknown", text: msg };
  }

  // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑ –ø—Ä–∏ –Ω–æ–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
  useEffect(() => {
    chatEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [messages]);

  return (
    <div
      style={{
        backgroundColor: "#000",
        color: "#0f0",
        fontFamily: "monospace",
        height: "100vh",
        display: "flex",
        flexDirection: "column",
        backgroundImage: "url('/chat-bg.jpg')",
        backgroundSize: "cover",
        backgroundPosition: "center",
      }}
    >
      ;{/* –ß–∞—Ç–æ–≤–æ–µ –æ–∫–Ω–æ */}
      <div
        style={{
          flex: 1,
          overflowY: "auto",
          padding: "1rem",
          marginBottom: "120px",
        }}
      >
        {messages.map((msg, i) => {
          const { author, text } = parseMessage(msg);

          const color = author === "batya" ? "#00ffff" : "#00ff00";
          const shadow =
            author === "batya" ? "0 0 6px #d500f9" : "0 0 4px #00ff00";

          return (
            <p
              key={i}
              style={{
                margin: "0.5rem 0",
                color,
                fontWeight: author === "batya" ? "bold" : "normal",
                textShadow: shadow,
              }}
            >
              {author === "batya" ? (
                <>
                  <span style={{ color: "#00ffff" }}></span>
                  <TypewriterText text={`[Batya404]: ${text}`} />
                </>
              ) : (
                <>
                  <span style={{ color: "#00ff00" }}>[You]: </span>
                  {text}
                </>
              )}
            </p>
          );
        })}

        <div ref={chatEndRef} />
      </div>
      {/* –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å */}
      <div
        style={{
          position: "fixed",
          bottom: 0,
          left: 0,
          width: "100%",
          backgroundColor: "rgba(0, 0, 0, 0.85)",
          borderTop: "1px solid #0f0",
          padding: "1rem",
          display: "flex",
          gap: "1rem",
          flexWrap: "wrap",
        }}
      >
        <button onClick={onClose} style={neonButtonStyle}>
          ‚úñ –ù–∞–∑–∞–¥
        </button>

        <input
          value={input}
          onChange={(e) => setInput(e.target.value)}
          onKeyDown={(e) => e.key === "Enter" && send()}
          placeholder="–°–∫–∞–∂–∏ –º–Ω–µ –∫—Ç–æ —Ç–≤–æ–π –¥—Ä—É–≥..."
          style={{
            flex: 1,
            minWidth: "200px",
            padding: "0.5rem",
            fontFamily: "monospace",
            backgroundColor: "#111",
            color: "#0f0",
            border: "1px solid #0f0",
          }}
        />
      </div>
    </div>
  );
}

const neonButtonStyle = {
  backgroundColor: "black",
  border: "1px solid #00ffff",
  color: "#00ffff",
  fontFamily: "monospace",
  fontSize: "14px",
  padding: "8px 16px",
  textShadow: "0 0 5px #00ffff",
  boxShadow: "0 0 8px #00ffff",
  cursor: "pointer",
  transition: "0.3s",
};
